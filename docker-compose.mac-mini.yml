# =============================================================================
# DOCKER COMPOSE - OPTIMIZED FOR MAC MINI M4 (16GB RAM)
# =============================================================================
# Performance targets:
# - Safe memory usage: ~10GB for Docker (leave 6GB for macOS)
# - Concurrent backtests: 4 simultaneous
# - GA evaluations: 4 parallel fitness calculations
# - Memory efficiency: 60% utilization
# =============================================================================

services:
  # ===========================================================================
  # REDIS - Message broker and result backend
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: quant-brain-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --tcp-backlog 128
      --maxclients 1000
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ===========================================================================
  # BACKEND - FastAPI server
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: quant-brain-backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - FASTAPI_HOST=0.0.0.0
      - FASTAPI_PORT=8000
      - PROJECT_ROOT=/app
      - PYTHONUNBUFFERED=1
      - GUNICORN_WORKERS=2
      - GUNICORN_THREADS=2
    command: >
      gunicorn app.main:app
      --workers 2
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --timeout 120
      --keep-alive 5
      --max-requests 500
      --max-requests-jitter 50
    volumes:
      - ./engine/data:/app/engine/data:ro
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ===========================================================================
  # CELERY WORKER - Background task processor
  # OPTIMIZED FOR MAC MINI M4 16GB RAM
  # ===========================================================================
  celery:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: quant-brain-celery
    command: >
      celery -A app.services.celery_app.celery worker
      --loglevel=info
      -Q default,backtest,optimization,ai_agent,quant_brain
      --concurrency=6
      --pool=prefork
      --max-memory-per-child=256000
      --max-tasks-per-child=50
    environment:
      # Redis
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - PROJECT_ROOT=/app
      - PYTHONUNBUFFERED=1

      # =========================================================================
      # MAC MINI M4 SPECIFICATIONS (16GB RAM)
      # =========================================================================
      - CPU_COUNT=6
      - TOTAL_RAM_GB=16
      - MIN_WORKERS=4
      - MAX_WORKERS=6

      # =========================================================================
      # CELERY WORKER SETTINGS - 6 WORKERS FOR 16GB
      # =========================================================================
      - CELERY_CONCURRENCY=6
      - CELERY_PREFETCH=1
      - CELERY_POOL=prefork
      - WORKER_MAX_MEMORY_KB=256000
      - WORKER_MAX_TASKS=50
      - BROKER_POOL_LIMIT=15

      # =========================================================================
      # PARALLEL PROCESSING - 6 WORKERS FOR 16GB
      # =========================================================================
      - MAX_PARALLEL_RUNS=300
      - MAX_THREAD_WORKERS=6
      - PROCESS_WORKERS=4
      - PARALLEL_FITNESS=true

      # =========================================================================
      # GENETIC ALGORITHM - 6 WORKERS
      # =========================================================================
      - GENOME_POPULATION_SIZE=30
      - GENOME_GENERATIONS=5
      - GA_PARALLEL_EVALUATIONS=6
      - GENOME_MUTATION_RATE=0.15
      - GENOME_CROSSOVER_RATE=0.8
      - GENOME_ELITE_COUNT=3

      # =========================================================================
      # MEMORY MANAGEMENT (10GB available for Docker)
      # =========================================================================
      - MAX_MEMORY_GB=8
      - DATA_CACHE_GB=2
      - MODEL_CACHE_GB=1

      # =========================================================================
      # CACHE SETTINGS - REDUCED
      # =========================================================================
      - INDICATOR_CACHE_SIZE=1024
      - DATA_CACHE_SIZE=256
      - INDICATOR_RESULT_CACHE_SIZE=512
      - REDIS_POOL_SIZE=20
      - DATA_PRELOAD=true
      - PROGRESS_BATCH_SIZE=1

      # =========================================================================
      # NUMBA/NUMPY OPTIMIZATION
      # =========================================================================
      - NUMBA_NUM_THREADS=4
      - USE_FAST_STRATEGY=true
      - NUMBA_CACHE_DIR=/tmp/numba_cache
      - OMP_NUM_THREADS=4
      - MKL_NUM_THREADS=4
      - NUMEXPR_NUM_THREADS=4
      - OPENBLAS_NUM_THREADS=4

      # =========================================================================
      # PYTHON OPTIMIZATION
      # =========================================================================
      - PYTHONOPTIMIZE=2
      - PYTHONHASHSEED=0
      - MALLOC_ARENA_MAX=2

      # =========================================================================
      # ROBUSTNESS TESTING - REDUCED
      # =========================================================================
      - MONTE_CARLO_RUNS=100
      - WALK_FORWARD_WINDOWS=2

      # =========================================================================
      # AUTO-TUNING - MORE AGGRESSIVE MEMORY LIMITS
      # =========================================================================
      - AUTO_TUNING_ENABLED=true
      - AUTO_TUNING_INTERVAL=5
      - TUNING_COOLDOWN_SEC=10
      - TUNING_MEMORY_HIGH_PCT=70
      - TUNING_MEMORY_SAFE_PCT=60
      - TUNING_CPU_HIGH_PCT=85
      - TUNING_MIN_WORKERS=4
      - TUNING_MAX_WORKERS=6

      # =========================================================================
      # TIMEOUTS - UNLIMITED
      # =========================================================================
      - JOB_TIMEOUT_SEC=0
      - MAX_STDOUT_SIZE=10485760

    volumes:
      - ./engine/data:/app/engine/data:ro
      - numba-cache:/tmp/numba_cache
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G

  # ===========================================================================
  # FRONTEND - React app served by nginx
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NODE_OPTIONS=--max_old_space_size=1024
    container_name: quant-brain-frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

volumes:
  redis-data:
  numba-cache:

networks:
  default:
    name: quant-brain-network
